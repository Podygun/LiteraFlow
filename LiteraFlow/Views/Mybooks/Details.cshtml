@model BookAndChaptersViewModel


  <div class="row">
    <div id="leftCol" class="col-12 col-lg-8 pe-4">

        <div class="row">
            <div class=" d-flex flex-wrap justify-content-center">
                <select class="selector" id="chapterSelector">
                    @for (int i = 0; i < @Model.Chapters.Count; i++)
                    {
                        <option value="@Model.Chapters[i].ChapterId">@Model.Chapters[i].Title</option>
                    }

                </select>
                <button class="btn_light" id="createChapterBtn">Новая глава</button>
            </div>

        </div>

        <form id="ChapterForm">
            @Html.AntiForgeryToken()
            <div>
                <label>
                    <div>Заголовок</div>
                    <input id="chapterTitle" value="@Model.Chapters[^1].Title" />

                </label>

            </div>
            <div class="mb-3">

                <p class="chapter_redactor" contenteditable="true" id="chapterText"></p>
            </div>


            <input type="hidden" name="ChapterId" id="chapterId" />

            <button type="button" id="saveChapterBtn">Сохранить</button>
        </form>

    </div>

    <div id="rightCol" class="ps-4 col-0 col-lg-4 d-flex flex-wrap justify-content-center">
        <div class="w-100">
            <form method="post" action="savesettings">
                @Html.AntiForgeryToken()
                <div class="mb-3">
                    <label class="form__label">Название</label>
                    <input class="form__input" name="Title" value="@Model.Book.Title" type="text" />
                </div>
                <div class="mb-3">
                    <label class="form__label">Описание</label>
                    <p class="form__p" name="Description" value="@Model.Book.Description" type="text" contenteditable="true">@Model.Book.Description</p>
                </div>
                <div class="mb-3">
                    <label class="form__label">Заметка</label>
                    <input class="form__input" name="AuthorNote" value="@Model.Book.AuthorNote" type="text" />
                </div>
                <div class="mb-3">
                    <label class="form__label">Цена</label>
                    <input class="form__input" name="Price" value="@Model.Book.Price" type="text" />
                </div>
                <input type="hidden" name="BookId" id="bookId" value="@Model.Book.BookId" />
                <button type="submit">Сохранить</button>
            </form>
        </div>
        


    </div>

    @* TODO Amount of letters *@

    <div class="toggle-button" id="toggleButton">
        <i style="cursor:pointer;" id="iconToggler" class="fa fa-angle-double-right text-black" aria-hidden="true"></i>
    </div>

    
    
    

</div>  

@section Scripts{
    <script defer>     
        $(document).ready(function () {

            const chapterSelector = document.getElementById("chapterSelector");
            const chapterText = document.getElementById("chapterText");
            const chapterTitle = document.getElementById("chapterTitle");
            const chapterId = document.getElementById("chapterId");
            

            function LoadChapterText() {
                let SelectedChapterId = chapterSelector.options[chapterSelector.selectedIndex].value;
                chapterId.value = SelectedChapterId;
                $.ajax({
                    type: "POST",
                    url: "@Url.Action("GetChapterText")",
                    dataType: "json",
                    data: { ChapterId: SelectedChapterId },
                    success: function (result) {
                        chapterText.textContent = result;
                    },
                    error: function (req, status, error) {
                        chapterText.textContent = status;
                    }
                });
            };

            function ChapterSelected(){

                LoadChapterText();
                chapterTitle.value = chapterSelector.options[chapterSelector.selectedIndex].textContent;
            };

            $("#saveChapterBtn").click(function () {
                let chapter = {
                    BookId: $("#bookId").val(),
                    Title: $("#chapterTitle").val(),
                    Text: $("#chapterText").text(),
                    ChapterId: $("#chapterId").val() || null,                    
                };

                $.ajax({
                    url: '@Url.Action("SaveChapter", "MyBooks")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(chapter),
                    success: function (result) {
                        //TODO popup
                        console.Log('Updated chapter with id: ' + result);
                    },
                    error: function (req, status, error) {
                        //TODO popup
                        chapterText.textContent = status;
                    }
                });
            });


            chapterSelector.addEventListener("change", ChapterSelected);

            chapterSelector.options[chapterSelector.options.length - 1].selected = true;
            ChapterSelected();

            // Logic of creating new chapter button
            const createChapterBtn = document.getElementById("createChapterBtn");

            createChapterBtn.addEventListener('click', function () {
                let newOption = document.createElement("option");
                newOption.textContent = "Новая глава";
                newOption.value = "Новая глава";
                newOption.selected = true;
                chapterSelector.appendChild(newOption);

                chapterText.textContent = "Текст";
                chapterTitle.value = "Новая глава";
                chapterId.value = null;
            });

            $("#toggleButton").click(function () {
                $("#leftCol").toggleClass("col-12 col-lg-12");
                $("#rightCol").toggleClass("col-0 col-lg-0 d-none");
                
                
                
                // Измените текст кнопки на основе состояния
                if ($("#leftCol").hasClass("col-12")) {
                    $("#iconToggler").removeClass("fa-angle-double-left");
                } else {
                    $("#iconToggler").addClass("fa-angle-double-left");
                }
            });

        });
    </script>
}

